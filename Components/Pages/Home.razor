@page "/"
@using Specifications.Models
@using Microsoft.JSInterop
@using System.Globalization
@inject IJSRuntime JSRuntime

<PageTitle>Home</PageTitle>

<h1>I.SCR.DEV</h1>
Welcome to your new app.

@if (!string.IsNullOrEmpty(Error))
{
    <div class="alert alert-danger" role="alert">
        @Error
        <button type="button" class="btn-close" @onclick="() => Error = null"></button>
    </div>
}

<div class="container-fluid">
    <div class="d-flex flex-column border rounded border-secondary p-5" style="min-height:800px">
        <h1>
            <div class="input-group w-50" data-bs-theme="dark">
                <span class="input-group-text"><i class="fa-solid fa-diagram-project"></i></span>
                <input type="string"
                       class="form-control"
                       placeholder="Project Name"
                       @bind="@ProjectTitle">
            </div>
        </h1>

        <div class="d-flex justify-content-end gap-3 my-3">
            <!-- Custom Summary Footer -->
            <div class="input-group w-25" data-bs-theme="dark">
                <span class="input-group-text"><i class="fa-solid fa-clock"></i></span>
                <input type="number" step="0.1" min="0" max="1000"
                       class="form-control"
                       placeholder="@GetTotalHours().ToString("F1") hrs"
                       disabled id="TotalHours">
            </div>
            <div class="input-group w-25" data-bs-theme="dark">
                <span class="input-group-text">$</span>
                <input type="number" step="0.1" min="0" max="1000"
                       class="form-control fw-bold text-success TotalCost"
                       placeholder="@GetTotalCost().ToString("C2")"
                       disabled
                       >
            </div>
            <div class="input-group w-25" data-bs-theme="dark">
                <span class="input-group-text">DA</span>
                <input type="number" step="0.1" min="0" max="1000"
                       class="form-control fw-bold text-success TotalCost"
                       placeholder="@((GetTotalCost() * ConvertionPrice).ToString("C2", CultureInfo.GetCultureInfo("fr-DZ")))"
                       disabled
                       >
            </div>
            <div class="input-group w-25" data-bs-theme="dark">
                <span class="input-group-text"><i class="fa-solid fa-money-bill-transfer"></i></span>
                <input type="number" step="0.1" min="0" max="1000"
                       class="form-control fw-bold text-success"
                       @bind="@ConvertionPrice">
            </div>

            <!--Price input-->
            <div class="input-group" style="width:15%" data-bs-theme="dark">
                <span class="input-group-text">$/h</span>
                <input type="number" step="0.1" min="0" max="1000"
                       class="form-control"
                       @bind="@HourPirce"
                       @bind:after="RefreshGrid">
            </div>

            <!--ADD button-->
            <button class="btn btn-outline-secondary text-nowrap" @onclick="AddSpecification">+ Detail</button>

            @if (SpecificationsListToDelete.Count > 0)
            {
                <!--delete button-->
                <button class="btn btn-outline-danger text-nowrap" @onclick="RemoveSelectedSpecifications">- Delete</button>
            }

            <!-- PDF Generation button -->
            <button class="btn btn-outline-info text-nowrap" @onclick="GeneratePdf">
                <i class="fa-solid fa-file-pdf "></i>  PDF
            </button>
        </div>

        @if (SpecificationsList.Count > 0)
        {
            <!-- Add a key to help Blazor track the Grid component properly -->
            <Grid @ref="SpecificationsGrid"
                  
                  TItem="SpeceficationsModel"
                  Class="table table-bordered table-striped text-center"
                  DataProvider="DataProvider"
                  AllowSelection="true"
                  SelectionMode="GridSelectionMode.Multiple"
                  @bind-SelectedItems="@SpecificationsListToDelete"
                  AllowSorting="true"
                  Responsive="true"
                  AllowPaging=true
                  PageSize="8"
                  HeaderRowCssClass="bg-dark text-white border-bottom-0">
                <GridColumns>
                    <GridColumn TItem="SpeceficationsModel" Class="text-secondary"  HeaderText="Title" HeaderTextAlignment="Alignment.Center" TextAlignment="Alignment.Center" PropertyName="Title" Sortable=false>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="@context.Title" @bind="@context.Title" @bind:after="OnSpecificationChanged" aria-label="@context.Title" data-bs-theme="dark">
                        </div>
                    </GridColumn>
                    <GridColumn TItem="SpeceficationsModel" Class="text-secondary" HeaderText="Description" HeaderTextAlignment="Alignment.Center" TextAlignment="Alignment.Center" PropertyName="Description" Sortable=false>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="@context.Description" @bind="@context.Description" @bind:after="OnSpecificationChanged" aria-label="@context.Description" data-bs-theme="dark">
                        </div>
                    </GridColumn>
                    <GridColumn TItem="SpeceficationsModel" Class="text-secondary" HeaderText="Duration (hrs)" HeaderTextAlignment="Alignment.Center" TextAlignment="Alignment.Center" PropertyName="Duration" SortKeySelector="item => item.Duration">
                        <div class="input-group">
                            <input type="number" step="0.1" min="0.1" max="@double.MaxValue" class="form-control" @bind="@context.Duration" @bind:after="OnSpecificationChanged" aria-label="@context.Duration" data-bs-theme="dark">
                        </div>
                    </GridColumn>
                    <GridColumn TItem="SpeceficationsModel" Class="text-secondary" HeaderText="Cost ($)" HeaderTextAlignment="Alignment.Center" TextAlignment="Alignment.Center">
                        @((context.Duration * HourPirce).ToString("C2"))
                    </GridColumn>
                    <GridColumn TItem="SpeceficationsModel" Class="text-secondary" HeaderText="Progress" HeaderTextAlignment="Alignment.Center" TextAlignment="Alignment.Center" PropertyName="StatusProgess" SortKeySelector="item => item.StatusProgess" Sortable=true>
                        @context.StatusProgess
                    </GridColumn>
                </GridColumns>
            </Grid>
        }
        else
        {
            <div class="text-center text-muted mt-5">
                <p>No specifications added yet. Click "Add specification" to get started.</p>
            </div>
        }
    </div>
    <!-- File Management Section -->
    <div class="row my-4">
        <div class="col-md-4">
            <div class="card" data-bs-theme="dark">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fa-solid fa-floppy-disk"></i> Save Current Project</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-success btn-sm w-100 mb-2" @onclick="ManualSave">
                        <i class="fa-solid fa-save"></i> Save Now
                    </button>
                    <button class="btn btn-secondary btn-sm w-100" @onclick="SaveAsNewFile">
                        <i class="fa-solid fa-file-plus"></i> Save As New
                    </button>
                    <small class="text-muted">Auto-saves every 30 seconds to: @(string.IsNullOrEmpty(currentSaveFile) ? "New file" : currentSaveFile)</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card" data-bs-theme="dark">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fa-solid fa-folder-open"></i> Load Project</h6>
                </div>
                <div class="card-body">
                    <select class="form-select form-select-sm mb-2" data-bs-theme="dark" @onchange="OnFileSelected">
                        <option value="">Select a file to load...</option>
                        @foreach (var file in AvailableFiles)
                        {
                            <option value="@file" selected="@(file == currentSaveFile)">@file</option>
                        }
                    </select>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" @onclick="LoadSelectedFile" disabled="@(string.IsNullOrEmpty(selectedFileName))">
                            <i class="fa-solid fa-upload"></i> Load
                        </button>
                        <button class="btn btn-info btn-sm" @onclick="LoadAvailableFiles">
                            <i class="fa-solid fa-refresh"></i> Refresh List
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card" data-bs-theme="dark">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fa-solid fa-trash"></i> Delete Project</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-danger btn-sm w-100" @onclick="DeleteSelectedFile" disabled="@(string.IsNullOrEmpty(selectedFileName))">
                        <i class="fa-solid fa-trash"></i> Delete Selected
                    </button>
                    <small class="text-muted">@AvailableFiles.Count file(s) available</small>
                </div>
            </div>
        </div>
    </div>
</div>

